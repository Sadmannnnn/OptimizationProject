#Если Сервер Тогда

// Тестирование модуля кэширования
Процедура Тест_Кэширования() Экспорт
    
    // Подготовка
    Ключ = "test_key_" + Строка(ТекущаяДата());
    ТестовыеДанные = Новый Массив;
    ТестовыеДанные.Добавить("Значение1");
    ТестовыеДанные.Добавить(42);
    ТестовыеДанные.Добавить(Новый Структура("Поле", "Значение"));
    
    // Тест 1: Сохранение и получение
    CacheManager.СохранитьВКэш(Ключ, ТестовыеДанные);
    ДанныеИзКэша = CacheManager.ПолучитьИзКэша(Ключ);
    
    Утверждение.Равно(ДанныеИзКэша, ТестовыеДанные, 
        "Данные должны совпадать после сохранения и получения");
    
    // Тест 2: Истечение срока жизни
    Ждать(2); // Ждем 2 секунды
    ДанныеПослеОжидания = CacheManager.ПолучитьИзКэша(Ключ, 1);
    
    Утверждение.НеОпределено(ДанныеПослеОжидания,
        "Данные должны истечь через 1 секунду");
    
    // Тест 3: Удаление
    CacheManager.СохранитьВКэш(Ключ, ТестовыеДанные);
    CacheManager.УдалитьИзКэша(Ключ);
    ДанныеПослеУдаления = CacheManager.ПолучитьИзКэша(Ключ);
    
    Утверждение.НеОпределено(ДанныеПослеУдаления,
        "Данные должны быть удалены");
    
КонецПроцедуры

// Тестирование оптимизированных запросов
Процедура Тест_ОптимизированногоЗапроса() Экспорт
    
    // Создание тестовых данных
    СоздатьТестовыеПродажи(100);
    
    // Тест производительности
    НачалоПериода = НачалоДня(ТекущаяДата() - 30);
    КонецПериода = КонецДня(ТекущаяДата());
    
    // Замер медленного запроса
    НачалоВремени = ТекущаяДата();
    РезультатМедленно = ТОПОтчет.ПолучитьТОПТоваров_Медленно(
        НачалоПериода, КонецПериода);
    ВремяМедленно = ТекущаяДата() - НачалоВремени;
    
    // Замер оптимизированного запроса
    НачалоВремени = ТекущаяДата();
    РезультатБыстро = ТОПОтчет.ПолучитьТОПТоваров(
        НачалоПериода, КонецПериода, "Месяц");
    ВремяБыстро = ТекущаяДата() - НачалоВремени;
    
    // Проверки
    Утверждение.Истина(ВремяБыстро < ВремяМедленно,
        "Оптимизированный запрос должен быть быстрее");
    
    Утверждение.Равно(РезультатБыстро.Количество(), 10,
        "Должно возвращаться 10 записей");
    
КонецПроцедуры

// Тестирование обработки ошибок
Процедура Тест_ОбработкиОшибок() Экспорт
    
    // Тест на некорректные параметры
    Попытка
        Результат = ТОПОтчет.ПолучитьТОПТоваров(
            Неопределено, Неопределено, "");
        Утверждение.Ложь("Должно быть исключение");
    Исключение
        // Ожидаемое исключение - тест пройден
        Утверждение.Истина("Корректная обработка ошибок");
    КонецПопытки;
    
КонецПроцедуры

// Запуск всех тестов
Процедура ЗапуститьВсеТесты() Экспорт
    
    Тесты = Новый Массив;
    Тесты.Добавить("Тест_Кэширования");
    Тесты.Добавить("Тест_ОптимизированногоЗапроса");
    Тесты.Добавить("Тест_ОбработкиОшибок");
    
    Результаты = Новый ТаблицаЗначений;
    Результаты.Колонки.Добавить("Тест");
    Результаты.Колонки.Добавить("Статус");
    Результаты.Колонки.Добавить("Сообщение");
    Результаты.Колонки.Добавить("Время");
    
    Для Каждого ИмяТеста Из Тесты Цикл
        НачалоВремени = ТекущаяДата();
        Попытка
            Выполнить(ИмяТеста + "()");
            Статус = "Успех";
            Сообщение = "";
        Исключение
            Статус = "Ошибка";
            Сообщение = ОписаниеОшибки();
        КонецПопытки;
        КонецВремени = ТекущаяДата();
        
        Строка = Результаты.Добавить();
        Строка.Тест = ИмяТеста;
        Строка.Статус = Статус;
        Строка.Сообщение = Сообщение;
        Строка.Время = КонецВремени - НачалоВремени;
    КонецЦикла;
    
    // Вывод результатов
    СформироватьОтчетТестов(Результаты);
    
КонецПроцедуры

#КонецЕсли
