<?xml version="1.0" encoding="UTF-8"?>
<ConfigurationExtension xmlns="http://v8.1c.ru/8.2/configuration-extension">
  <Properties>
    <Property name="Имя">РасширениеОтчетаТОПТоваров</Property>
    <Property name="Синоним">Расширение отчета ТОП товаров</Property>
    <Property name="Комментарий">Добавляет экспорт в Excel и дополнительные фильтры</Property>
  </Properties>
  
  <ObjectExtensions>
    <ObjectExtension object="Report.ОтчетТОПТоваров">
      
      <!-- Добавляем кнопку экспорта в Excel -->
      <Method name="СоздатьКнопкуЭкспорта">
        &НаКлиенте
        // Создаем кнопку экспорта на форме
        КнопкаЭкспорт = ЭлементыФормы.Добавить("КнопкаЭкспорт", Тип("Кнопка"));
        КнопкаЭкспорт.Заголовок = "Экспорт в Excel";
        КнопкаЭкспорт.Расположение = РасположениеЭлементаФормы.НижнийЦентр;
        КнопкаЭкспорт.Действие = "ЭкспортВExcel";
      </Method>
      
      <!-- Метод экспорта в Excel -->
      <Method name="ЭкспортВExcel">
        &НаСервере
        Данные = ЭтотОбъект.ПолучитьДанныеОтчета(
          НачалоПериода,
          КонецПериода,
          Детализация
        );
        
        // Создаем табличный документ
        ТабличныйДокумент = Новый ТабличныйДокyмент;
        ТабличныйДокумент.КлючевыеСтроки.Добавить(1);
        
        // Заголовок
        ТабличныйДокумент.Область(1, 1, 1, 3).Текст = 
          "Отчет ТОП товаров за период: " + 
          Формат(НачалоПериода, "ДФ=dd.MM.yyyy") + " - " + 
          Формат(КонецПериода, "ДФ=dd.MM.yyyy");
        
        // Заголовки колонок
        ТабличныйДокумент.Область(3, 1).Текст = "Товар";
        ТабличныйДокумент.Область(3, 2).Текст = "Количество";
        ТабличныйДокумент.Область(3, 3).Текст = "Сумма";
        
        // Данные
        Строка = 4;
        Для Каждого Запись Из Данные Цикл
          ТабличныйДокумент.Область(Строка, 1).Текст = Запись.Товар;
          ТабличныйДокумент.Область(Строка, 2).Текст = Формат(Запись.Продано, "ЧГ=0");
          ТабличныйДокумент.Область(Строка, 3).Текст = Формат(Запись.Сумма, "ЧДЦ=2");
          Строка = Строка + 1;
        КонецЦикла;
        
        // Сохраняем в файл
        ИмяФайла = "Отчет_ТОП_товаров_" + Формат(ТекущаяДата(), "ДФ=ddMMyyyy_HHmm") + ".xlsx";
        ТабличныйДокумент.Записать(ИмяФайла);
        
        ОповещениеПользователя("Отчет экспортирован в файл: " + ИмяФайла);
      </Method>
      
      <!-- Добавляем фильтр по подразделению -->
      <Method name="ДобавитьФильтрПодразделения">
        &НаСервере
        // Расширяем запрос для поддержки фильтра по подразделению
        ТекстЗапроса = 
        "ВЫБРАТЬ
        |    Номенклатура.Наименование КАК Товар,
        |    Продажи.Подразделение КАК Подразделение,
        |    СУММА(Продажи.КоличествоОборот) КАК Продано,
        |    СУММА(Продажи.СуммаОборот) КАК Сумма
        |ИЗ
        |    РегистрНакопления.Продажи.Обороты(&Начало, &Конец, День, Номенклатура, Подразделение) КАК Продажи
        |        ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Номенклатура
        |        ПО Продажи.Номенклатура = Номенклатура.Ссылка
        |ГДЕ
        |    Продажи.Подразделение = &Подразделение
        |СГРУППИРОВАТЬ ПО
        |    Номенклатура.Наименование,
        |    Продажи.Подразделение
        |УПОРЯДОЧИТЬ ПО
        |    СУММА(Продажи.КоличествоОборот) УБЫВ";
        
        Возврат ТекстЗапроса;
      </Method>
      
    </ObjectExtension>
  </ObjectExtensions>
</ConfigurationExtension>
