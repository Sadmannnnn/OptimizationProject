<?xml version="1.0" encoding="UTF-8"?>
<Configuration xmlns="http://v8.1c.ru/8.2/configuration">
  <MetaDataObject name="Утилиты" uuid="utilities-uuid">
    <Properties>
      <Property name="Имя">Утилиты</Property>
      <Property name="Синоним">Утилиты</Property>
      <Property name="Комментарий">Общие утилитарные функции</Property>
      <Property name="Глобальный">true</Property>
      <Property name="Серверный">true</Property>
      <Property name="ВнешнееСоединение">false</Property>
      <Property name="Клиентский">true</Property>
    </Properties>
    <Module>
      &НаСервере
      // Генерация случайного числа в диапазоне
      Функция СлучайноеЧисло(Знач Минимум = 1, Знач Максимум = 100) Экспорт
        Возврат Минимум + (Максимум - Минимум) * ?(ГлобальныйКонтекст.СлучайноеЧисло, 
          ГлобальныйКонтекст.СлучайноеЧисло(), Случай());
      КонецФункции
      
      // Форматирование интервала времени
      Функция ФорматироватьИнтервал(Знач Начало, Знач Конец) Экспорт
        Интервал = Конец - Начало;
        
        Секунды = Цел(Интервал);
        Минуты = 0;
        Часы = 0;
        
        Если Секунды >= 60 Тогда
          Минуты = Цел(Секунды / 60);
          Секунды = Секунды % 60;
        КонецЕсли;
        
        Если Минуты >= 60 Тогда
          Часы = Цел(Минуты / 60);
          Минуты = Минуты % 60;
        КонецЕсли;
        
        Результат = "";
        Если Часы > 0 Тогда
          Результат = Результат + Часы + " ч ";
        КонецЕсли;
        Если Минуты > 0 Тогда
          Результат = Результат + Минуты + " мин ";
        КонецЕсли;
        Если Секунды > 0 Или Результат = "" Тогда
          Результат = Результат + Секунды + " сек";
        КонецЕсли;
        
        Возврат Результат;
      КонецФункции
      
      // Преобразование таблицы значений в JSON строку
      Функция ТаблицаВJSON(Знач Таблица) Экспорт
        Если Таблица = Неопределено Тогда
          Возврат "[]";
        КонецЕсли;
        
        Результат = "[";
        Для i = 0 По Таблица.Количество() - 1 Цикл
          Строка = Таблица[i];
          Результат = Результат + "{";
          
          Для j = 0 По Таблица.Колонки.Количество() - 1 Цикл
            Колонка = Таблица.Колонки[j];
            Значение = Строка[Колонка.Имя];
            
            Результат = Результат + """ + Колонка.Имя + "":";
            
            Если ТипЗнч(Значение) = Тип("Строка") Тогда
              Результат = Результат + """ + Значение + """;
            ИначеЕсли ТипЗнч(Значение) = Тип("Число") Тогда
              Результат = Результат + Строка(Значение);
            ИначеЕсли ТипЗнч(Значение) = Тип("Дата") Тогда
              Результат = Результат + """ + Формат(Значение, "ДФ='dd.MM.yyyy HH:mm:ss'") + """;
            ИначеЕсли ТипЗнч(Значение) = Тип("Булево") Тогда
              Результат = Результат + ?(Значение, "true", "false");
            Иначе
              Результат = Результат + "null";
            КонецЕсли;
            
            Если j < Таблица.Колонки.Количество() - 1 Тогда
              Результат = Результат + ",";
            КонецЕсли;
          КонецЦикла;
          
          Результат = Результат + "}";
          Если i < Таблица.Количество() - 1 Тогда
            Результат = Результат + ",";
          КонецЕсли;
        КонецЦикла;
        
        Результат = Результат + "]";
        Возврат Результат;
      КонецФункции
      
      // Проверка производительности запроса
      Функция ИзмеритьПроизводительностьЗапроса(Знач ТекстЗапроса, Знач Параметры = Неопределено) Экспорт
        
        НачалоВремени = ТекущаяДата();
        
        Попытка
          Запрос = Новый Запрос;
          Запрос.Текст = ТекстЗапроса;
          
          Если Параметры <> Неопределено Тогда
            Для Каждого Параметр Из Параметры Цикл
              Запрос.УстановитьПараметр(Параметр.Ключ, Параметр.Значение);
            КонецЦикла;
          КонецЕсли;
          
          Результат = Запрос.Выполнить();
          Данные = Результат.Выгрузить();
          
          КонецВремени = ТекущаяДата();
          ВремяВыполнения = КонецВремени - НачалоВремени;
          
          РезультатИзмерения = Новый Структура;
          РезультатИзмерения.Вставить("ВремяМс", ВремяВыполнения * 1000);
          РезультатИзмерения.Вставить("КоличествоСтрок", Данные.Количество());
          РезультатИзмерения.Вставить("Успешно", Истина);
          РезультатИзмерения.Вставить("Данные", Данные);
          
        Исключение
          КонецВремени = ТекущаяДата();
          ВремяВыполнения = КонецВремени - НачалоВремени;
          
          РезультатИзмерения = Новый Структура;
          РезультатИзмерения.Вставить("ВремяМс", ВремяВыполнения * 1000);
          РезультатИзмерения.Вставить("КоличествоСтрок", 0);
          РезультатИзмерения.Вставить("Успешно", Ложь);
          РезультатИзмерения.Вставить("Ошибка", ОписаниеОшибки());
          
        КонецПопытки;
        
        Возврат РезультатИзмерения;
        
      КонецФункции
      
      // Создание индексов для оптимизации (пример)
      Процедура СоздатьИндексыДляОптимизации() Экспорт
        
        // Пример создания индекса для документа Реализация
        Попытка
          // В реальном проекте это делается через СУБД
          // Здесь демонстрация логики
          Запрос = Новый Запрос;
          Запрос.Текст = 
          "-- Создание индекса для быстрого поиска по дате
          |-- CREATE INDEX idx_Реализация_Дата ON Реализация(Дата)";
          
          Запрос.Выполнить();
          
          Утилиты.ЗаписьВЖурналРегистрации("Созданы индексы для оптимизации", 
            УровеньЖурналаРегистрации.Информация, "СоздатьИндексыДляОптимизации");
            
        Исключение
          Утилиты.ЗаписьВЖурналРегистрации("Ошибка создания индексов: " + ОписаниеОшибки(), 
            УровеньЖурналаРегистрации.Ошибка, "СоздатьИндексыДляОптимизации");
        КонецПопытки;
        
      КонецПроцедуры
      
      // Функция записи в журнал из этого модуля
      Процедура ЗаписьВЖурналРегистрации(Сообщение, Уровень = Неопределено, 
                                        Метод = Неопределено, Данные = Неопределено,
                                        Комментарий = "") Экспорт
        
        Если Уровень = Неопределено Тогда
          Уровень = УровеньЖурналаРегистрации.Информация;
        КонецЕсли;
        
        Если Метод = Неопределено Тогда
          Метод = "Утилиты";
        КонецЕсли;
        
        Попытка
          ЗаписьЖурналаРегистрации = Новый ЗаписьЖурналаРегистрации;
          ЗаписьЖурналаРегистрации.Метод = Метод;
          ЗаписьЖурналаРегистрации.Уровень = Уровень;
          ЗаписьЖурналаРегистрации.Сообщение = Сообщение;
          ЗаписьЖурналаРегистрации.Комментарий = Комментарий;
          
          Если Данные <> Неопределено Тогда
            ЗаписьЖурналаРегистрации.Данные = Данные;
          КонецЕсли;
          
          ЗаписьЖурналаРегистрации.Записать();
        Исключение
          // Игнорируем ошибки записи в журнал
        КонецПопытки;
        
      КонецПроцедуры
      
      // Проверка наличия регистра сведений КэшОтчетов
      Функция КэшОтчетовДоступен() Экспорт
        Попытка
          // Пробуем выполнить простой запрос к регистру
          Запрос = Новый Запрос;
          Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 Ключ ИЗ РегистрСведений.КэшОтчетов";
          Запрос.Выполнить();
          Возврат Истина;
        Исключение
          Возврат Ложь;
        КонецПопытки;
      КонецФункции
      
    КонецЦикла;
  </MetaDataObject>
</Configuration>
