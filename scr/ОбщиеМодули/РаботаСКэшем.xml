<?xml version="1.0" encoding="UTF-8"?>
<Configuration xmlns="http://v8.1c.ru/8.2/configuration">
  <MetaDataObject name="РаботаСКэшем" uuid="cache-handler-uuid">
    <Properties>
      <Property name="Имя">РаботаСКэшем</Property>
      <Property name="Синоним">Работа с кэшем</Property>
      <Property name="Комментарий">Общие функции для работы с кэшем отчетов</Property>
      <Property name="Глобальный">true</Property>
      <Property name="Серверный">true</Property>
      <Property name="ВнешнееСоединение">false</Property>
      <Property name="Клиентский">false</Property>
    </Properties>
    <Module>
      &НаСервере
      // Получить значение из кэша
      Функция ПолучитьИзКэша(Знач Ключ, Знач ВремяЖизниСекунды = 300) Экспорт
        
        Запрос = Новый Запрос;
        Запрос.Текст = 
        "ВЫБРАТЬ
        |    КэшОтчетов.Данные,
        |    КэшОтчетов.ДатаМодификации
        |ИЗ
        |    РегистрСведений.КэшОтчетов КАК КэшОтчетов
        |ГДЕ
        |    КэшОтчетов.Ключ = &Ключ
        |    И КэшОтчетов.ДатаМодификации > &МинДата";
        
        МинДата = ТекущаяДатаСеанса() - ВремяЖизниСекунды;
        Запрос.УстановитьПараметр("Ключ", Ключ);
        Запрос.УстановитьПараметр("МинДата", МинДата);
        
        Результат = Запрос.Выполнить();
        Выборка = Результат.Выбрать();
        
        Если Выборка.Следующий() Тогда
          Попытка
            Возврат Выборка.Данные.Получить();
          Исключение
            // Если данные повреждены, удаляем запись
            УдалитьИзКэша(Ключ);
            Возврат Неопределено;
          КонецПопытки;
        КонецЕсли;
        
        Возврат Неопределено;
        
      КонецФункции
      
      // Сохранить значение в кэш
      Процедура СохранитьВКэш(Знач Ключ, Знач Данные) Экспорт
        
        // Сначала удаляем старую запись
        УдалитьИзКэша(Ключ);
        
        Попытка
          Запись = РегистрыСведений.КэшОтчетов.СоздатьНаборЗаписей();
          НоваяЗапись = Запись.Добавить();
          НоваяЗапись.Ключ = Ключ;
          НоваяЗапись.Данные.Установить(Данные);
          НоваяЗапись.ДатаМодификации = ТекущаяДатаСеанса();
          
          Запись.Записать();
        Исключение
          // Логируем ошибку, но не прерываем выполнение
          ЗаписьВЖурналРегистрации("Ошибка сохранения в кэш", 
            УровеньЖурналаРегистрации.Ошибка, , , 
            "Ключ: " + Ключ + ", Ошибка: " + ОписаниеОшибки());
        КонецПопытки;
        
      КонецПроцедуры
      
      // Удалить значение из кэша
      Процедура УдалитьИзКэша(Знач Ключ) Экспорт
        
        Запрос = Новый Запрос;
        Запрос.Текст = 
        "ВЫБРАТЬ
        |    КэшОтчетов.Ключ
        |ИЗ
        |    РегистрСведений.КэшОтчетов КАК КэшОтчетов
        |ГДЕ
        |    КэшОтчетов.Ключ = &Ключ
        |ДЛЯ ИЗМЕНЕНИЯ";
        
        Запрос.УстановитьПараметр("Ключ", Ключ);
        
        Попытка
          Результат = Запрос.Выполнить();
          Выборка = Результат.Выбрать();
          
          Пока Выборка.Следующий() Цикл
            Выборка.Удалить();
          КонецЦикла;
        Исключение
          // Игнорируем ошибки при удалении несуществующей записи
        КонецПопытки;
        
      КонецПроцедуры
      
      // Очистить весь кэш
      Процедура ОчиститьВесьКэш() Экспорт
        
        Попытка
          Запрос = Новый Запрос;
          Запрос.Текст = 
          "ВЫБРАТЬ
          |    КэшОтчетов.Ключ
          |ИЗ
          |    РегистрСведений.КэшОтчетов КАК КэшОтчетов
          |ДЛЯ ИЗМЕНЕНИЯ";
          
          Результат = Запрос.Выполнить();
          Выборка = Результат.Выбрать();
          
          Пока Выборка.Следующий() Цикл
            Выборка.Удалить();
          КонецЦикла;
          
          ЗаписьВЖурналРегистрации("Кэш отчетов полностью очищен", 
            УровеньЖурналаРегистрации.Информация);
            
        Исключение
          ЗаписьВЖурналРегистрации("Ошибка очистки кэша", 
            УровеньЖурналаРегистрации.Ошибка, , , ОписаниеОшибки());
        КонецПопытки;
        
      КонецПроцедуры
      
      // Инвалидация кэша при изменении данных
      Процедура ИнвалидироватьКэшПриИзмененииПродаж(Знач ДатаИзменения) Экспорт
        
        // Удаляем все записи кэша, которые содержат данные за дату изменения
        Запрос = Новый Запрос;
        Запрос.Текст = 
        "ВЫБРАТЬ
        |    КэшОтчетов.Ключ
        |ИЗ
        |    РегистрСведений.КэшОтчетов КАК КэшОтчетов
        |ГДЕ
        |    КэшОтчетов.Ключ ПОДОБНО ""ТОП%"" + &ДатаСтр + ""%""
        |    ИЛИ КэшОтчетов.Ключ ПОДОБНО ""ПРОДАЖИ%"" + &ДатаСтр + ""%""
        |ДЛЯ ИЗМЕНЕНИЯ";
        
        ДатаСтр = Формат(ДатаИзменения, "ДФ=dd.MM.yyyy");
        Запрос.УстановитьПараметр("ДатаСтр", ДатаСтр);
        
        Попытка
          Результат = Запрос.Выполнить();
          Выборка = Результат.Выбрать();
          
          КоличествоУдалено = 0;
          Пока Выборка.Следующий() Цикл
            Выборка.Удалить();
            КоличествоУдалено = КоличествоУдалено + 1;
          КонецЦикла;
          
          Если КоличествоУдалено > 0 Тогда
            ЗаписьВЖурналРегистрации("Инвалидирован кэш для даты: " + ДатаСтр, 
              УровеньЖурналаРегистрации.Информация);
          КонецЕсли;
          
        Исключение
          ЗаписьВЖурналРегистрации("Ошибка инвалидации кэша", 
            УровеньЖурналаРегистрации.Ошибка);
        КонецПопытки;
        
      КонецПроцедуры
      
      // Вспомогательная функция для записи в журнал регистрации
      Процедура ЗаписьВЖурналРегистрации(Сообщение, Уровень = Неопределено, 
                                        Метод = Неопределено, Данные = Неопределено,
                                        Комментарий = "") Экспорт
        
        Если Уровень = Неопределено Тогда
          Уровень = УровеньЖурналаРегистрации.Информация;
        КонецЕсли;
        
        Если Метод = Неопределено Тогда
          Метод = "РаботаСКэшем";
        КонецЕсли;
        
        Попытка
          ЗаписьЖурналаРегистрации = Новый ЗаписьЖурналаРегистрации;
          ЗаписьЖурналаРегистрации.Метод = Метод;
          ЗаписьЖурналаРегистрации.Уровень = Уровень;
          ЗаписьЖурналаРегистрации.Сообщение = Сообщение;
          ЗаписьЖурналаРегистрации.Комментарий = Комментарий;
          
          Если Данные <> Неопределено Тогда
            ЗаписьЖурналаРегистрации.Данные = Данные;
          КонецЕсли;
          
          ЗаписьЖурналаРегистрации.Записать();
        Исключение
          // Если не получается записать в журнал, просто игнорируем
        КонецПопытки;
        
      КонецПроцедуры
    </Module>
  </MetaDataObject>
</Configuration>
