<?xml version="1.0" encoding="UTF-8"?>
<Configuration xmlns="http://v8.1c.ru/8.2/configuration">
  <MetaDataObject name="РаботаСКэшем" uuid="cache-module-uuid">
    <Properties>
      <Property name="Имя">РаботаСКэшем</Property>
      <Property name="Глобальный">true</Property>
      <Property name="Серверный">true</Property>
      <Property name="ВнешнееСоединение">false</Property>
    </Properties>
    <Module>
      &НаСервере
      // Получить данные из кэша
      Функция ПолучитьИзКэша(Ключ, ВремяЖизниСекунды = 300) Экспорт
        
        Запрос = Новый Запрос;
        Запрос.Текст = 
        "ВЫБРАТЬ
        |    КэшОтчетов.Данные
        |ИЗ
        |    РегистрСведений.КэшОтчетов КАК КэшОтчетов
        |ГДЕ
        |    КэшОтчетов.Ключ = &Ключ
        |    И КэшОтчетов.ДатаМодификации > &ДатаАктуальности";
        
        Запрос.УстановитьПараметр("Ключ", Ключ);
        Запрос.УстановитьПараметр("ДатаАктуальности", 
          ДобавитьКДате(ТекущаяДатаСеанса(), 0, 0, -ВремяЖизниСекунды));
        
        Результат = Запрос.Выполнить();
        Выборка = Результат.Выбрать();
        
        Если Выборка.Следующий() Тогда
          Возврат Выборка.Данные.Получить();
        КонецЕсли;
        
        Возврат Неопределено;
        
      КонецФункции
      
      // Сохранить данные в кэш
      Процедура СохранитьВКэш(Ключ, Данные) Экспорт
        
        // Удаляем старую запись если есть
        УдалитьИзКэша(Ключ);
        
        // Создаем новую запись
        Запись = РегистрыСведений.КэшОтчетов.СоздатьНаборЗаписей();
        НоваяЗапись = Запись.Добавить();
        НоваяЗапись.Ключ = Ключ;
        НоваяЗапись.Данные.Установить(Данные);
        НоваяЗапись.ДатаМодификации = ТекущаяДатаСеанса();
        
        Запись.Записать();
        
      КонецПроцедуры
      
      // Удалить из кэша
      Процедура УдалитьИзКэша(Ключ) Экспорт
        
        Запрос = Новый Запрос;
        Запрос.Текст = 
        "ВЫБРАТЬ
        |    КэшОтчетов.Ключ
        |ИЗ
        |    РегистрСведений.КэшОтчетов КАК КэшОтчетов
        |ГДЕ
        |    КэшОтчетов.Ключ = &Ключ
        |ДЛЯ ИЗМЕНЕНИЯ";
        
        Запрос.УстановитьПараметр("Ключ", Ключ);
        Результат = Запрос.Выполнить();
        Выборка = Результат.Выбрать();
        
        Пока Выборка.Следующий() Цикл
          Выборка.Удалить();
        КонецЦикла;
        
      КонецПроцедуры
      
      // Очистить весь кэш
      Процедура ОчиститьКэш() Экспорт
        
        Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ КэшОтчетов.Ключ ИЗ РегистрСведений.КэшОтчетов КАК КэшОтчетов ДЛЯ ИЗМЕНЕНИЯ");
        Результат = Запрос.Выполнить();
        Выборка = Результат.Выбрать();
        
        Пока Выборка.Следующий() Цикл
          Выборка.Удалить();
        КонецЦикла;
        
        Оповещение("Кэш отчетов полностью очищен");
        
      КонецПроцедуры
    </Module>
  </MetaDataObject>
</Configuration>
