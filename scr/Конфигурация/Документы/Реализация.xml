<?xml version="1.0" encoding="UTF-8"?>
<Configuration xmlns="http://v8.1c.ru/8.2/configuration">
  <MetaDataObject name="Реализация" uuid="sale-doc-uuid">
    <Properties>
      <Property name="Имя">Реализация</Property>
      <Property name="Синоним">Реализация товаров</Property>
      <Property name="Комментарий">Документ продажи товаров</Property>
      <Property name="Проведение">true</Property>
    </Properties>
    
    <!-- Реквизиты шапки документа -->
    <Attributes>
      <Attribute name="Номер" type="Number">
        <Properties>
          <Property name="Имя">Номер</Property>
          <Property name="Автонумерация">true</Property>
        </Properties>
      </Attribute>
      <Attribute name="Дата" type="DateTime">
        <Properties>
          <Property name="Имя">Дата</Property>
          <Property name="Индексирование">true</Property>
        </Properties>
      </Attribute>
      <Attribute name="Контрагент" type="CatalogRef.Контрагенты">
        <Properties>
          <Property name="Имя">Контрагент</Property>
        </Properties>
      </Attribute>
      <Attribute name="Сумма" type="Number" length="15" precision="2">
        <Properties>
          <Property name="Имя">Сумма</Property>
        </Properties>
      </Attribute>
    </Attributes>
    
    <!-- Табличная часть с товарами -->
    <ChildObjects>
      <ChildObject name="Товары">
        <Properties>
          <Property name="Имя">Товары</Property>
          <Property name="Синоним">Товары</Property>
        </Properties>
        <Attributes>
          <Attribute name="Номенклатура" type="CatalogRef.Номенклатура">
            <Properties>
              <Property name="Имя">Номенклатура</Property>
            </Properties>
          </Attribute>
          <Attribute name="Количество" type="Number" length="10" precision="3">
            <Properties>
              <Property name="Имя">Количество</Property>
            </Properties>
          </Attribute>
          <Attribute name="Цена" type="Number" length="15" precision="2">
            <Properties>
              <Property name="Имя">Цена</Property>
            </Properties>
          </Attribute>
          <Attribute name="Сумма" type="Number" length="15" precision="2">
            <Properties>
              <Property name="Имя">Сумма</Property>
              <Property name="Вычисляемое">true</Property>
              <Property name="Выражение">Количество * Цена</Property>
            </Properties>
          </Attribute>
        </Attributes>
      </ChildObject>
    </ChildObjects>
    
    <!-- Модуль объекта -->
    <Module>
      &НаСервере
      // Обработка проведения документа
      Процедура ОбработкаПроведения(Отказ, Режим)
        Если Режим = РежимПроведенияДокумента.Проведение Тогда
          // Рассчитываем сумму документа
          РассчитатьСумму();
          
          // Создаем движения по регистрам
          Движения.Продажи.Записать = Истина;
          
          Для Каждого СтрокаТовара Из Товары Цикл
            Движение = Движения.Продажи.Добавить();
            Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
            Движение.Период = Дата;
            Движение.Номенклатура = СтрокаТовара.Номенклатура;
            Движение.Количество = СтрокаТовара.Количество;
            Движение.Сумма = СтрокаТовара.Сумма;
          КонецЦикла;
        Иначе
          // Сторнирование
          Движения.Продажи.Записать = Истина;
          
          Для Каждого СтрокаТовара Из Товары Цикл
            Движение = Движения.Продажи.Добавить();
            Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
            Движение.Период = Дата;
            Движение.Номенклатура = СтрокаТовара.Номенклатура;
            Движение.Количество = СтрокаТовара.Количество;
            Движение.Сумма = СтрокаТовара.Сумма;
          КонецЦикла;
        КонецЕсли;
      КонецПроцедуры
      
      // Расчет суммы документа
      Процедура РассчитатьСумму()
        СуммаДокумента = 0;
        Для Каждого Строка Из Товары Цикл
          Строка.Сумма = Строка.Количество * Строка.Цена;
          СуммаДокумента = СуммаДокумента + Строка.Сумма;
        КонецЦикла;
        Сумма = СуммаДокумента;
      КонецПроцедуры
      
      // При изменении строк табличной части
      &НаКлиенте
      Процедура ТоварыПриИзменении(Элемент)
        РассчитатьСуммуНаСервере();
      КонецПроцедуры
      
      &НаСервере
      Процедура РассчитатьСуммуНаСервере()
        РассчитатьСумму();
      КонецПроцедуры
    </Module>
  </MetaDataObject>
</Configuration>
