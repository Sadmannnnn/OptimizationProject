<?xml version="1.0" encoding="UTF-8"?>
<Configuration xmlns="http://v8.1c.ru/8.2/configuration">
  <MetaDataObject name="Продажи" uuid="sales-register-uuid">
    <Properties>
      <Property name="Имя">Продажи</Property>
      <Property name="Синоним">Продажи товаров</Property>
      <Property name="Комментарий">Регистр накопления продаж для аналитики</Property>
      <Property name="Вид">Остатки</Property>
    </Properties>
    
    <!-- Измерения -->
    <Dimensions>
      <Dimension name="Номенклатура">
        <Properties>
          <Property name="Имя">Номенклатура</Property>
          <Property name="Тип">CatalogRef.Номенклатура</Property>
        </Properties>
      </Dimension>
      <Dimension name="Подразделение">
        <Properties>
          <Property name="Имя">Подразделение</Property>
          <Property name="Тип">CatalogRef.Подразделения</Property>
        </Properties>
      </Dimension>
    </Dimensions>
    
    <!-- Ресурсы -->
    <Resources>
      <Resource name="Количество">
        <Properties>
          <Property name="Имя">Количество</Property>
          <Property name="Тип">Number</Property>
          <Property name="Длина">10</Property>
          <Property name="Точность">3</Property>
        </Properties>
      </Resource>
      <Resource name="Сумма">
        <Properties>
          <Property name="Имя">Сумма</Property>
          <Property name="Тип">Number</Property>
          <Property name="Длина">15</Property>
          <Property name="Точность">2</Property>
        </Properties>
      </Resource>
    </Resources>
    
    <!-- Реквизиты -->
    <Attributes>
      <Attribute name="Документ" type="DocumentRef.Реализация">
        <Properties>
          <Property name="Имя">Документ</Property>
        </Properties>
      </Attribute>
    </Attributes>
    
    <!-- Виртуальные таблицы для быстрой аналитики -->
    <VirtualTables>
      <VirtualTable name="Обороты">
        <Properties>
          <Property name="Имя">Обороты</Property>
          <Property name="Синоним">Обороты</Property>
          <Property name="Периодичность">День</Property>
          <Property name="Измерения">
            <List>
              <Item>Номенклатура</Item>
            </List>
          </Property>
          <Property name="Ресурсы">
            <List>
              <Item>Количество</Item>
              <Item>Сумма</Item>
            </List>
          </Property>
        </Properties>
      </VirtualTable>
      <VirtualTable name="Остатки">
        <Properties>
          <Property name="Имя">Остатки</Property>
          <Property name="Синоним">Остатки</Property>
          <Property name="Измерения">
            <List>
              <Item>Номенклатура</Item>
              <Item>Подразделение</Item>
            </List>
          </Property>
          <Property name="Ресурсы">
            <List>
              <Item>Количество</Item>
              <Item>Сумма</Item>
            </List>
          </Property>
        </Properties>
      </VirtualTable>
    </VirtualTables>
    
    <!-- Модуль менеджера регистра -->
    <Module>
      &НаСервере
      // Пример функции для получения популярных товаров
      Функция ПолучитьПопулярныеТовары(НачалоПериода, КонецПериода, Топ = 10) Экспорт
        
        Запрос = Новый Запрос;
        Запрос.Текст = 
        "ВЫБРАТЬ
        |    ПродажиОбороты.Номенклатура КАК Номенклатура,
        |    СУММА(ПродажиОбороты.КоличествоОборот) КАК КоличествоПродаж,
        |    СУММА(ПродажиОбороты.СуммаОборот) КАК СуммаПродаж
        |ИЗ
        |    РегистрНакопления.Продажи.Обороты(&НачалоПериода, &КонецПериода, День, Номенклатура) КАК ПродажиОбороты
        |СГРУППИРОВАТЬ ПО
        |    ПродажиОбороты.Номенклатура
        |УПОРЯДОЧИТЬ ПО
        |    СУММА(ПродажиОбороты.КоличествоОборот) УБЫВ";
        
        Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
        Запрос.УстановитьПараметр("КонецПериода", КонецПериода);
        
        Результат = Запрос.Выполнить();
        
        // Ограничиваем количество
        ТаблицаРезультат = Результат.Выгрузить();
        Если ТаблицаРезультат.Количество() > Топ Тогда
          НоваяТаблица = Новый ТаблицаЗначений;
          НоваяТаблица.Колонки.Добавить("Номенклатура");
          НоваяТаблица.Колонки.Добавить("КоличествоПродаж");
          НоваяТаблица.Колонки.Добавить("СуммаПродаж");
          
          Для i = 0 По Топ - 1 Цикл
            Строка = НоваяТаблица.Добавить();
            Строка.Номенклатура = ТаблицаРезультат[i].Номенклатура;
            Строка.КоличествоПродаж = ТаблицаРезультат[i].КоличествоПродаж;
            Строка.СуммаПродаж = ТаблицаРезультат[i].СуммаПродаж;
          КонецЦикла;
          
          Возврат НоваяТаблица;
        КонецЕсли;
        
        Возврат ТаблицаРезультат;
        
      КонецФункции
      
      // Функция для получения остатков на дату
      Функция ПолучитьОстаткиНаДату(ДатаОстатков, Номенклатура = Неопределено) Экспорт
        
        Запрос = Новый Запрос;
        ТекстЗапроса = 
        "ВЫБРАТЬ
        |    ПродажиОстатки.Номенклатура КАК Номенклатура,
        |    ПродажиОстатки.Подразделение КАК Подразделение,
        |    ПродажиОстатки.КоличествоОстаток КАК КоличествоОстаток,
        |    ПродажиОстатки.СуммаОстаток КАК СуммаОстаток
        |ИЗ
        |    РегистрНакопления.Продажи.Остатки(&ДатаОстатков, , Номенклатура, Подразделение) КАК ПродажиОстатки";
        
        Если Номенклатура <> Неопределено Тогда
          ТекстЗапроса = ТекстЗапроса + "
          |ГДЕ
          |    ПродажиОстатки.Номенклатура = &Номенклатура";
        КонецЕсли;
        
        Запрос.Текст = ТекстЗапроса;
        Запрос.УстановитьПараметр("ДатаОстатков", ДатаОстатков);
        
        Если Номенклатура <> Неопределено Тогда
          Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
        КонецЕсли;
        
        Результат = Запрос.Выполнить();
        Возврат Результат.Выгрузить();
        
      КонецФункции
    </Module>
  </MetaDataObject>
</Configuration>
