#Если Сервер Тогда

// Структура для хранения метрик
СтруктураМетрики = Новый Структура(
    "ИмяЗапроса,ВремяВыполнения,КоличествоСтрок,Дата,Успешно"
);

// Сбор метрик производительности
Процедура ЗаписатьМетрику(ИмяЗапроса, Время, Строк, Успех = Истина) Экспорт
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВСТАВИТЬ В РегСвед.МетрикиПроизводительности
    |ИМЕЮЩИЕСЯ
    |    Метрика,
    |    Время,
    |    КоличествоСтрок,
    |    Дата,
    |    Успешно
    |ЗНАЧЕНИЯ
    |    &Метрика, &Время, &Строк, &Дата, &Успех";
    
    Запрос.УстановитьПараметр("Метрика", ИмяЗапроса);
    Запрос.УстановитьПараметр("Время", Время);
    Запрос.УстановитьПараметр("Строк", Строк);
    Запрос.УстановитьПараметр("Дата", ТекущаяДатаСеанса());
    Запрос.УстановитьПараметр("Успех", Успех);
    
    Запрос.Выполнить();
КонецПроцедуры

// Анализ медленных запросов
Функция ПолучитьМедленныеЗапросы(Лимит = 10) Экспорт
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    Метрика,
    |    СРЕДНЕЕ(Время) КАК СреднееВремя,
    |    КОЛИЧЕСТВО(*) КАК Вызовов
    |ИЗ РегСвед.МетрикиПроизводительности
    |ГДЕ Время > 1.0 // Более 1 секунды
    |СГРУППИРОВАТЬ ПО Метрика
    |УПОРЯДОЧИТЬ ПО СреднееВремя УБЫВ
    |ОГРАНИЧИТЬ &Лимит";
    
    Запрос.УстановитьПараметр("Лимит", Лимит);
    Возврат Запрос.Выполнить().Выгрузить();
КонецФункции

#КонецЕсли
