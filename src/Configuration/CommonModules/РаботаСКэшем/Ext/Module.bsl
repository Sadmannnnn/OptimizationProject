#Если Сервер Тогда

// Получить значение из кэша
Функция ПолучитьИзКэша(Знач Ключ, Знач ВремяЖизниСекунды = 300) Экспорт
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    КэшОтчетов.Данные,
    |    КэшОтчетов.ДатаМодификации
    |ИЗ
    |    РегистрСведений.КэшОтчетов КАК КэшОтчетов
    |ГДЕ
    |    КэшОтчетов.Ключ = &Ключ
    |    И КэшОтчетов.ДатаМодификации > &МинДата";
    
    МинДата = ТекущаяДатаСеанса() - ВремяЖизниСекунды;
    Запрос.УстановитьПараметр("Ключ", Ключ);
    Запрос.УстановитьПараметр("МинДата", МинДата);
    
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    Если Выборка.Следующий() Тогда
        Попытка
            Возврат Выборка.Данные.Получить();
        Исключение
            // Если данные повреждены
            УдалитьИзКэша(Ключ);
            Возврат Неопределено;
        КонецПопытки;
    КонецЕсли;
    
    Возврат Неопределено;
    
КонецФункции

// Сохранить в кэш
Процедура СохранитьВКэш(Знач Ключ, Знач Данные) Экспорт
    
    УдалитьИзКэша(Ключ);
    
    Попытка
        Запись = РегистрыСведений.КэшОтчетов.СоздатьНаборЗаписей();
        НоваяЗапись = Запись.Добавить();
        НоваяЗапись.Ключ = Ключ;
        НоваяЗапись.Данные.Установить(Данные);
        НоваяЗапись.ДатаМодификации = ТекущаяДатаСеанса();
        
        Запись.Записать();
    Исключение
        // Логируем ошибку
        ЗаписьВЖурналРегистрации("Ошибка сохранения в кэш: " + ОписаниеОшибки(), 
            УровеньЖурналаРегистрации.Ошибка);
    КонецПопытки;
    
КонецПроцедуры

#КонецЕсли
