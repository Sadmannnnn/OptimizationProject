#Если Сервер Тогда

Функция ПолучитьДанныеОтчета(НачалоПериода, КонецПериода, Детализация) Экспорт
    
    КлючКэша = СтрШаблон("ТОП_Товаров_%1_%2_%3", 
        Формат(НачалоПериода, "ДФ=dd.MM.yyyy"),
        Формат(КонецПериода, "ДФ=dd.MM.yyyy"),
        Детализация);
    
    // Пытаемся получить из кэша
    ДанныеКэша = РаботаСКэшем.ПолучитьИзКэша(КлючКэша, 300);
    
    Если ДанныеКэша <> Неопределено Тогда
        Возврат ДанныеКэша;
    КонецЕсли;
    
    // Оптимизированный запрос через регистры
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    Номенклатура.Наименование КАК Товар,
    |    СУММА(Продажи.КоличествоОборот) КАК Продано,
    |    СУММА(Продажи.СуммаОборот) КАК Сумма
    |ИЗ
    |    РегистрНакопления.Продажи.Обороты(&Начало, &Конец, День, Номенклатура) КАК Продажи
    |        ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Номенклатура
    |        ПО Продажи.Номенклатура = Номенклатура.Ссылка
    |СГРУППИРОВАТЬ ПО
    |    Номенклатура.Наименование
    |УПОРЯДОЧИТЬ ПО
    |    СУММА(Продажи.КоличествоОборот) УБЫВ
    |ОГРАНИЧИТЬ 10";
    
    Запрос.УстановитьПараметр("Начало", НачалоПериода);
    Запрос.УстановитьПараметр("Конец", КонецПериода);
    
    Результат = Запрос.Выполнить();
    Данные = Результат.Выгрузить();
    
    // Сохраняем в кэш
    РаботаСКэшем.СохранитьВКэш(КлючКэша, Данные);
    
    Возврат Данные;
    
КонецФункции

#КонецЕсли
