#Если Сервер Тогда

Процедура ОбработкаПроведения(Отказ, Режим)
    
    Если Режим = РежимПроведенияДокумента.Проведение Тогда
        
        // Рассчитываем сумму документа
        РассчитатьСумму();
        
        // Движения по регистрам
        Движения.Продажи.Записать = Истина;
        
        Для Каждого СтрокаТовара Из Товары Цикл
            Движение = Движения.Продажи.Добавить();
            Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
            Движение.Период = Дата;
            Движение.Номенклатура = СтрокаТовара.Номенклатура;
            Движение.Количество = СтрокаТовара.Количество;
            Движение.Сумма = СтрокаТовара.Сумма;
        КонецЦикла;
        
        // Инвалидация кэша
        ИнвалидироватьКэшДляДаты(Дата);
        
    Иначе
        // Сторнирование
        Движения.Продажи.Записать = Истина;
        
        Для Каждого СтрокаТовара Из Товары Цикл
            Движение = Движения.Продажи.Добавить();
            Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
            Движение.Период = Дата;
            Движение.Номенклатура = СтрокаТовара.Номенклатура;
            Движение.Количество = СтрокаТовара.Количество;
            Движение.Сумма = СтрокаТовара.Сумма;
        КонецЦикла;
        
    КонецЕсли;
    
КонецПроцедуры

#КонецЕсли
