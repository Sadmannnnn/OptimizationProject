stages:
  - test
  - build
  - deploy

variables:
  DOCKER_IMAGE: registry.gitlab.com/your-project/1c-optimization:$CI_COMMIT_REF_SLUG

# Тестирование
unit-tests:
  stage: test
  image: 1c-test-runner:latest
  script:
    - echo "Запуск unit-тестов..."
    - /opt/1c/8.3/x86_64/1cestart /Execute tests/UnitTests.bsl
    - /opt/1c/scripts/run-tests.sh
  artifacts:
    paths:
      - test-results/
    reports:
      junit: test-results/junit.xml
  only:
    - merge_requests
    - main

# Сборка Docker образа
build-docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t $DOCKER_IMAGE -f docker/Dockerfile .
    - docker push $DOCKER_IMAGE
  only:
    - main
    - tags

# Деплой в тестовое окружение
deploy-test:
  stage: deploy
  image: alpine:latest
  script:
    - apk add --no-cache curl
    - |
      curl -X POST \
        -H "Content-Type: application/json" \
        -d '{"ref":"main"}' \
        $JENKINS_URL/job/1C-Deploy-Test/build?token=$JENKINS_TOKEN
  environment:
    name: test
    url: https://test.1c-project.example.com
  only:
    - main

# Сборка .epf файлов
build-epf:
  stage: build
  image: 1c-build:latest
  script:
    - |
      /opt/1c/8.3/x86_64/1cestart \
        /BuildEPF src/ExternalDataProcessors/TopProductsReport \
        -o bin/TopProductsReport.epf
    - |
      /opt/1c/8.3/x86_64/1cestart \
        /BuildEPF src/ExternalDataProcessors/TestDataGenerator \
        -o bin/TestDataGenerator.epf
  artifacts:
    paths:
      - bin/*.epf
  only:
    - tags
