#Если Сервер Тогда

// Экспорт метрик в Prometheus
Функция ЭкспортироватьМетрики() Экспорт
    
    Метрики = Новый Массив;
    
    // Метрики производительности
    МедленныеЗапросы = PerformanceMonitor.ПолучитьМедленныеЗапросы(50);
    Для Каждого Запрос Из МедленныеЗапросы Цикл
        Метрики.Добавить(СформироватьМетрику(
            "1c_slow_query_duration_seconds",
            Запрос.СреднееВремя,
            "query_name=\"" + Запрос.Метрика + "\""));
    КонецЦикла;
    
    // Метрики кэша
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    КОЛИЧЕСТВО(*) КАК ВсегоЗаписей,
    |    КОЛИЧЕСТВО(ВЫБОР КОГДА ДатаМодификации > &Время5мин ТОГДА 1 КОНЕЦ) КАк Активных
    |ИЗ РегСвед.КэшОтчетов";
    
    Запрос.УстановитьПараметр("Время5мин", ТекущаяДатаСеанса() - 300);
    Результат = Запрос.Выполнить().Выбрать();
    
    Если Результат.ВсегоЗаписей > 0 Тогда
        КоэфПопадания = Результат.Активных / Результат.ВсегоЗаписей;
        Метрики.Добавить(СформироватьМетрику(
            "1c_cache_hit_ratio", КоэфПопадания, ""));
    КонецЕсли;
    
    // Метрики базы данных
    Метрики.Добавить(СформироватьМетрику(
        "1c_database_size_bytes", 
        ПолучитьРазмерБазыДанных(), 
        "database=\"1c_test_db\""));
    
    Возврат Метрики;
    
КонецФункции

Функция СформироватьМетрику(Имя, Значение, Метки)
    Возврат Имя + "{" + Метки + "} " + Строка(Значение);
КонецФункции

#КонецЕсли
